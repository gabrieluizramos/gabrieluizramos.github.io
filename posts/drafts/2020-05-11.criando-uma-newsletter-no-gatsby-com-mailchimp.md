---
path: /draft/criando-uma-newsletter-no-gatsby-com-mailchimp

title: Criando uma Newsletter no Gatsby com Mailchimp
subtitle: O passo a passo da cria√ß√£o do feed RSS, integra√ß√£o com Mailchimp, desenvolvimento do formul√°rio de cadastro e envio dos emails
date: 2020-05-11
tags:
  - dev
  - react

banner:
  author: Tim Evans
  href: https://unsplash.com/photos/Uf-c4u1usFQ
  image: ./images/2020-05-11.criando-uma-newsletter-no-gatsby-com-mailchimp/banner.jpg
---

Recentemente implementei uma Newsletter aqui no blog (inclusive voc√™ participar se quiser, √© s√≥ se cadastrar no fim do post!) utilizando [Mailchimp](https://mailchimp.com/) e foi uma integra√ß√£o bem legal de se fazer.

Como √© algo bem comum nos nesse cen√°rio de blogs (e qualquer outro tipo de site) talvez possa ser √∫til para voc√™ tamb√©m.

---

### Mas, antes de tudo, o que √© uma Newsletter?
`Newsletter` (ou "Boletim Informativo") √© o nome dado pra modalidade de inscri√ß√£o onde voc√™ cadastra seu e-mail e recebe novidades e uma s√©rie de publica√ß√µes de algum produto, servi√ßo ou site. Talvez voc√™ receba em seu e-mail diariamente algumas not√≠cias e posts de
algum outro blog que voc√™ se cadastrou ou site que costuma acessar (talvez sua inscri√ß√£o no Medium).

Isso que √© uma Newsletter.

---

### Bora l√°!
A ideia da Newsletter √© deix√°-la automatizada a partir de qualquer novo post ou conte√∫do do seu site/blog.

Voc√™ consegue (utilizando o pr√≥prio Mailchimp) enviar emails para uma lista de usu√°rios quando quiser de forma bem simples, sem necessariamente automatizar ou criar um feed (como vermos mais abaixo). Entretanto, para um blog ou algum servi√ßo de not√≠cias √© interessante deixar tudo pronto para avisar as pessoas inscritas sobre qualquer conte√∫do novo que esteja no ar.

Pra implementar uma Newsletter usando Mailchimp com esse modelo, vale a pena dividir o conte√∫do em 3 partes:
- Cria√ß√£o de um Feed RSS;
- Cria√ß√£o da Campanha no Mailchimp (com ou sem opt-in duplo);
- Desenvolvimento do formul√°rio de assinatura.

Ent√£o, vamos por partes...

### Cria√ß√£o do Feed RSS
Para iniciar a integra√ß√£o, primeiro voc√™ precisa configurar e ter um feed RSS no seu site. Esse arquivo √© um XML que cont√©m informa√ß√µes √∫teis sobre os seus posts para que sistemas (e at√© leitores) possam consumir. Ele vai ser necess√°rio para que o Mailchimp possa consumir e consultar as informa√ß√µes de posts novos e disparar os e-mails automaticamente.

Para fazer isso √© bem f√°cil e j√° existe um plugin pronto no Gatsby: o [gatsby-plugin-feed](https://www.gatsbyjs.org/packages/gatsby-plugin-feed/).

A documenta√ß√£o dele t√° bem bacana e √© bem f√°cil de seguir, voc√™ consegue customizar os itens que v√£o aparecer no seu feed praticamente como qualquer outro plugin do Gatsby (no meu caso, eu [excluo todos os posts que est√£o como rascunho](https://github.com/gabrieluizramos/gabrieluizramos.com.br/blob/master/gatsby-config.js#L148) e n√£o est√£o prontos para serem publicados).

Ent√£o o primeiro passo √© configurar pra que seu feed exporte os posts da forma como mais se adequar √† maneira que voc√™ gostaria de enviar os emails e quais informa√ß√µes ser√£o √∫teis pra voc√™. Disponibilize esse feed em alguma URL de sua prefer√™ncia, no meu caso, [meu feed ficou assim](https://gabrieluizramos.com.br/feed.xml).

### Cria√ß√£o da Campanha RSS no Mailchimp
Provavelmente essa parte √© a mais manual e a mais chatinha de todo o processo, j√° que aqui √© que voc√™ precisa definir como seu disparo de e-mail vai funcionar.

Voc√™ vai precisar criar uma conta no site do [Mailchimp](https://mailchimp.com/).
Durante o tutorial e processo de configura√ß√£o da sua conta voc√™ consegue iniciar a cria√ß√£o de um template de e-mail ou adiar essa cria√ß√£o para o momento que for criar a sua Campanha (que √© a nomenclatura que o Mailchimp usa para definir esses disparos de email).

Com a configura√ß√£o da sua conta finalizada, para criar sua Campanha automatizada, no seu painel do Mailchimp, selecione `Create -> Email`.
Isso far√° com que uma modal abra para voc√™ selecionar o tipo de email que deseja configurar, com isso, clique em `Automated` e selecione a categoria `Share blog updates`. Com isso, essa modal mostrar√° uma op√ß√£o para voc√™ selecionar uma audi√™nca (que √© uma lista de emails que voc√™ pode configurar par disparo), essa audi√™ncia j√° vir√° com uma op√ß√£o para voc√™ escolher ap√≥s a configura√ß√£o inicial da sua conta.
Finalizada essa etapa, basta clicar em `begin` para iniciar a cria√ß√£o da sua Campanha.

Agora voc√™ ir√° configurar os detalhes de disparo, feed e template que utilizar√°, e √© dividido em 6 etapas:
1. RSS Feed: aqui voc√™ deve informar a URL do seu arquivo de Feed, que foi configurado e gerado. Ap√≥s informar a URL, voc√™ deve informar quando os emails devem ser enviados. Marque os dias que voc√™ achar mais adequado e vale se atentar ao timezone que o Mailchimp utiliza (Eastern) e fazer um "de -> para" da timezone que voc√™ deseja disparar;
1. Recipients: aqui voc√™ seleciona a audi√™ncia (aquele p√∫blico alvo da sua lista) que receber√° os emails dessa campanha. Se quiser segmentar ou criar algumas tags para dividir quem receber√° as novidades, voc√™ tamb√©m consegue nessa etapa;
1. Setup: √© a etapa que voc√™ vai configurar alguns detalhes dos emails que ser√£o enviados (assunto, descri√ß√£o, nome do remetente e outras informa√ß√µes);
1. Template: √© onde voc√™ escolhe a base do seu template, com quantas colunas quer e e qual modelo j√° existente prefere utilizar;
1. Design: a parte mais trabalhosa de todo o processo, onde voc√™ vai definir os blocos e as informa√ß√µes do seu template de email. Vale prestar bastante aten√ß√£o aqui pros blocos existentes que cont√©m informa√ß√£o **RSS** (o RSS Header e RSS Items), eles j√° vem com alguns dados prontos pra facilitar a cria√ß√£o do seu template. Pra facilitar a sua cria√ß√£o, tem [um guia](https://mailchimp.com/pt/help/rss-merge-tags/) que detalha todas as tags que o Mailchimp usa para mesclar os dados do feed RSS com o seu template que √© bastante √∫til nessa etapa;
1. Confirm: √© a etapa final, onde basicamente voc√™ revisa os dados e inicia a sua campanha com tudo o que configurou at√© o momento.

Passando essas etapas voc√™ pode confirmar o in√≠cio da Campanha ou, caso te deixe mais confort√°vel, esperar o desenvolvimento e inser√ß√£o do formul√°rio de inscri√ß√£o que vamos ver a seguir (se quiser deixar tudo preparado antes de iniciar os disparos de sua Newsletter).

#### Opt-in duplo (ou dupla aceita√ß√£o)
Outro ajuste que vale a pena ser feito agora √© a configura√ß√£o de opt-in (ou aceita√ß√£o) duplo. Sabe quando voc√™ se inscreve em algum site e recebe, no endere√ßo de email cadastrado, um email de confirma√ß√£o?

Essa etapa de opt-in duplo serve justamente pra isso, configurar essa confirma√ß√£o dupla de inscri√ß√£o. Dessa forma, voc√™ evita que pessoas cadastrem emails falsos na sua lista de audi√™ncia, j√° que a pessoa interessada em receber suas novidades, receber√° automaticamente um email para confirmar sua inscri√ß√£o e, possivelmente, um recaptcha para confirmar que n√£o √© um rob√¥.

Ativar essa op√ß√£o √© bem simples e voc√™ faz ela com alguns poucos cliques. Atrav√©s do painel do Mailchimp ([admin.mailchimp.com](https://admin.mailchimp.com/)) √© s√≥ acessar a aba `Audience`, depois clicar no select `Manage Audience -> Settings`, depois selecionar a op√ß√£o ` Audience name and defaults`. Ao acessar essa tela, existe uma parte chamada `Form settings` e √© s√≥ selecionar o checkbox com a op√ß√£o `Enable double opt-in`. Se quiser selecionar a op√ß√£o `Enable reCAPTCHA` tamb√©m voc√™ adiciona uma camada a mais de confiabilidade nos formul√°rios de inscri√ß√£o.

Caso n√£o queira ativar essa op√ß√£o, todos os usu√°rios que preencherem seu formul√°rio estar√£o automaticamente inscritos na sua audi√™ncia sem passar por qualquer "filtro".

Caso precise de mais um suporte, esses links de documenta√ß√£o do Mailchimp podem ser √∫teis:
- [Compartilhe suas publica√ß√µes de blog com o Mailchimp](https://mailchimp.com/pt/help/share-your-blog-posts-with-mailchimp/)
- [Etiquetas de Mesclagem RSS (as merge tags)](https://mailchimp.com/pt/help/rss-merge-tags/)
- [Sobre aceita√ß√£o dupla (double opt-in)](https://mailchimp.com/pt/help/about-double-opt-in/)
- [Encontra o ID do seu p√∫blico](https://mailchimp.com/pt/help/find-audience-id/)

### Desenvolvimento do formul√°rio de assinatura
Chegou a hora de colocar a m√£o no c√≥digo. Pra desenvolver esse formul√°rio vamos utilizar o plugin [`gatsby-plugin-mailchimp`](https://www.gatsbyjs.org/packages/gatsby-plugin-mailchimp/).

Esse plugin basicamente disponibiliza uma fun√ß√£o que √© respons√°vel por cadastrar os dados dos usu√°rios (como email e nome) na lista da sua audi√™ncia no Mailchimp.

Para fazer isso, ap√≥s instalar o plugin, √© necess√°rio consultar o endpoint disponibilizado pelo Mailchimp que √© utilizado para realizar o cadastro desses usu√°rios e pra fazer isso √© bem simples e a forma mais f√°cil que encontrei foi a seguinte: na p√°gina da sua audi√™ncia (igual acessamos anteriormente), basta selecionar a op√ß√£o `Signup forms` e depois a op√ß√£o `Embedded forms`. Depois disso, voc√™ pode selecionar qualquer formul√°rio que o pr√≥prio Mailchimp vai gerar um HTML para voc√™ utilizar no seu site e, nesse HTML, existir√° uma tag `<form>` onde a `action` ser√° justamente esse endpoint de cadastro que utilizaremos no plugin.

Caso queira simplesmente utilizar o formul√°rio deles, sem configurar ou customizar mais nenhuma op√ß√£o, voc√™ pode copiar e colar o c√≥digo sem problemas. Mas ao longo desse passo vamos customizar um componente para tratar os estados e os disparos pra gente.

Feito isso, agora √© s√≥ configurar o plugin no seu projeto (no arquivo `gatsby-config.js`):

```js
plugins: [
  {
    resolve: 'gatsby-plugin-mailchimp',
    options: {
        endpoint: '', // url do seu endpoint
    },
  },
];
```

E vamos ao desenvolvimento!

Esse plugin exporta uma fun√ß√£o `default` e, nas docs, o pessoal utiliza ela com o nome `addToMailChimp`. Ent√£o, no seu formul√°rio, basta import√°-la como:

```js
import addToMailChimp from 'gatsby-plugin-mailchimp';
```

Essa deve receber como par√¢metro o email do usu√°rio e pode receber tamb√©m um objeto com algumas informa√ß√µes adicionais (como nome da pessoa que se cadastrou) e retorna uma Promise.

Ent√£o, sua execu√ß√£o, no fim do processo ser√° algo como:

```js
import addToMailChimp from 'gatsby-plugin-mailchimp';

addToMailChimp('usuario@email.com', { FNAME: 'Nome' })
// .then()
// .catch()
```

Na [documenta√ß√£o](https://www.gatsbyjs.org/packages/gatsby-plugin-mailchimp/#returns) eles deixam bem claro que a Promise sempre ser√° resolvida com `200` (mesmo que resolva com erro) e o que difere no caso de sucess/erro √© o campo "result". Eu me deparei com um caso em espec√≠fico que essa Promise falhava: nos casos onde o usu√°rio, possivelmente, havia se cadastrado mas n√£o tinha confirmado o email de opt-in duplo, ent√£o, seguindo boas pr√°ticas em geral, vale a pena tratarmos poss√≠veis casos de erro, mesmo que isso n√£o seja uma resposta 100% correta da API.

No meu caso, preferi tratar essa mensagem como um poss√≠vel aviso e, fora isso, tratar os casos de sucesso/falha independentendemente com algumas mensagens separadas:

```js
const messages = {
  success: 'Prontinho! Agora √© s√≥ confirmar sua inscri√ß√£o no email que voc√™ vai receber em instantes.',
  error: 'Ops! Parece que que tivemos algum erro... Por favor, tente novamente.',
  warning: 'Voc√™ deve ter recebido um email para confirmar sua inscri√ß√£o. Caso n√£o receba, tente novamente em alguns instantes por favor.'
};
```

Mantendo duas vari√°veis de estado (`result` e `sending`) para os estados de resposta do envio e carregamento. E trato os disparos e mensagens da seguinte forma:

```jsx
import React, { useState } from 'react';

// import Form from 'components/form';

import addToMailChimp from 'gatsby-plugin-mailchimp';

const messages = {
  success: 'Prontinho! Agora √© s√≥ confirmar sua inscri√ß√£o no email que voc√™ vai receber em instantes.',
  error: 'Ops! Parece que que tivemos algum erro... Por favor, tente novamente.',
  warning: 'Voc√™ deve ter recebido um email para confirmar sua inscri√ß√£o. Caso n√£o receba, tente novamente em alguns instantes por favor.'
}

const Newsletter = () => {
  const [result, setResult] = useState('');
  const [sending, setSending] = useState(false);

  const getPathName = () => window.location.pathname;

  const subscribe = ({
    FNAME,
    email,
    pathname = getPathName()
  }) => addToMailChimp(email, { FNAME, pathname })

  const onSubmit = async (values) => {
    setSending(true);
    try {
      const { result } = await subscribe(values);
      setResult(result);
    } catch (err) {
      setResult('warning');
    }
    setSending(false);
  };

  const renderMessage = () => result && !sending && (
    <div>
      {messages[result]}
    </div>
  );

  return (
    // <Form onSubmit={onSubmit} disabled={sending} />
    {renderMessage()}
  );
};

export default Newsletter;
```

Dessa forma consigo tratar o estado de envio (disparando ou n√£o a requisi√ß√£o) e desabilitar o bot√£o de cadastro para que o usu√°rio n√£o consiga disparar v√°rias vezes a requisi√ß√£o.

Deixei o componente comentado e o `import` apenas pois isso pode variar da forma como voc√™ lida com formul√°rios. Acredito que com o que temos at√© aqui voc√™ j√° consegue implementar todo o fluxo de cadastro e disparo da Newsletter por si s√≥, j√° que agora √© apenas configurar as suas prefer√™ncias de formul√°rio como for mais adequada ao seu projeto.

Se quiser ver com mais detalhes como eu implementei esse formul√°rio, voc√™ pode conferir diretamente no componente que criei de `Newsletter` que est√° no [github](https://github.com/gabrieluizramos/gabrieluizramos.com.br/blob/master/src/templates/post/article/newsletter/index.js).

---

### Finalizamos o desenvolvimento da Newsletter! ‚úâÔ∏è
Agora basta confirmar (caso ainda n√£o tenha confirmado) a cria√ß√£o da sua campanha no painel do Mailchimp e pronto! Os pr√≥ximos posts que forem adicionados ao seu arquivo do Feed RSS j√° ser√£o automaticamente enviados para sua audi√™ncia usando o template e tudo que criamos ao longo desse processo.

Sei que o post ficou grande, mas espero que tenha gostado e que possa te ajudar caso precise implementar alguma coisa parecida utilizando Mailchimp e Feed RSS no seu site/blog com Gatsby!

Aproveitando que chegamos at√© aqui, o que acha de se inscrever na Newsletter que criei aqui pro blog seguindo exatamente esse processo?

√â s√≥ preencher o formul√°rio que t√° a√≠ embaixo e confirmar sua inscri√ß√£o no email (opt-in duplo üòâ) que voc√™ vai receber!
